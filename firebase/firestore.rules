rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.role == "admin" ||
        exists(/databases/$(database)/documents/adminUids/$(request.auth.uid))
      );
    }

    function isAdminOrAnalyst() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.role == "admin" ||
        request.auth.token.role == "analyst" ||
        exists(/databases/$(database)/documents/adminUids/$(request.auth.uid))
      );
    }

    // Privacy model:
    // - Municipal users only see published aggregates for their city.
    // - Raw telemetry collections are restricted to admin/analyst only.
    function municipalProfile() {
      return get(/databases/$(database)/documents/municipalUsers/$(request.auth.uid)).data;
    }

    function hasMunicipalAccess(cityId) {
      return isSignedIn()
        && municipalProfile() != null
        && municipalProfile().active == true
        && municipalProfile().cityId == cityId;
    }

    function canReadMunicipalCity(cityId) {
      return hasMunicipalAccess(cityId);
    }

    function isPublishedAggregate() {
      return resource.data.published == true;
    }

    function isPublishedAggregateQuery() {
      return request.query != null && request.query.where("published", "==", true);
    }

    // User can read their own access profile (dashboard needs this)
    match /municipalUsers/{uid} {
      allow get: if isSignedIn() && request.auth.uid == uid;
      allow list: if false;
      allow create, update, delete: if isAdmin();
    }

    // Aggregates: municipal users can read ONLY their city
    match /citySegmentAggregates/{cityId}/segments/{segmentKey} {
      allow get: if isAdminOrAnalyst()
        || (hasMunicipalAccess(cityId) && isPublishedAggregate());
      allow list: if isAdminOrAnalyst()
        || (hasMunicipalAccess(cityId) && isPublishedAggregateQuery());
      allow create, update, delete: if false; // server only
    }

    match /segmentAggregates/{cityId}/segments/{segmentId} {
      allow read: if isAdminOrAnalyst() || canReadMunicipalCity(cityId);
      allow create, update, delete: if false;
    }

    // Raw telemetry: admin/analyst only
    match /telemetrySegmentPasses/{docId} {
      allow write: if true; // ingestion
      allow read: if isAdmin();
    }

    match /RoadTelemetry/{docId} {
      allow read: if isAdminOrAnalyst();
      allow write: if false;
    }

    match /cities/{cityId}/RoadTelemetry/{docId} {
      allow read: if isAdminOrAnalyst();
      allow write: if false;
    }

    function resourceCityId() {
      return resource.data.cityId != null
        ? resource.data.cityId
        : (resource.data.city_id != null
          ? resource.data.city_id
          : (resource.data.cityKey != null
            ? resource.data.cityKey
            : resource.data.municipalityId));
    }

    function currentMeta() {
      return get(/databases/$(database)/documents/garageMeta/current);
    }

    match /usernames/{uname} {
      // Allow checking a single username document (availability check)
      allow get: if true;

      // Prevent enumerating all usernames
      allow list: if false;

      // Only the signed-in user can claim a username doc that matches the doc id
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.uid
        && request.resource.data.usernameLower == uname
        && !exists(/databases/$(database)/documents/usernames/$(uname));

      // Allow user to update only their own username doc
      allow update: if request.auth != null && resource.data.uid == request.auth.uid;

      // Disallow deletes (prevent release)
      allow delete: if false;
    }

    match /users/{uid} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == uid;
      allow delete: if false;
    }

    match /adminUids/{uid} {
      // allow signed-in users to read their own admin doc (portal verifies access)
      allow read: if request.auth != null && request.auth.uid == uid;

      // keep writes locked down (v1: console-only)
      allow write: if false;
    }

    match /garageMeta/{docId} {
      allow read: if docId == "current";
      allow write: if isAdmin();
    }

    match /garageAvatars/{avatarId} {
      allow read: if currentMeta().exists() &&
        avatarId == currentMeta().data.currentAvatarId &&
        resource.data.published == true;
      allow write: if isAdmin();
    }

    match /garageAudit/{document=**} {
      allow write: if isAdmin();
    }

    match /appContentDrafts/{pageKey} {
      allow read, write: if isAdmin();
    }

    match /appContent/{pageKey} {
      allow read: if resource.data.published == true;
      allow write: if isAdmin();

      match /revisions/{revId} {
        allow read, write: if isAdmin();
      }
    }

    match /educationDrafts/{draftId} {
      allow read, write: if isAdmin();
    }

    match /educationCards/{cardId} {
      allow read: if resource.data.published == true;
      allow write: if isAdmin();

      match /revisions/{revId} {
        allow read, write: if isAdmin();
      }
    }

    match /appContent/{document=**} {
      allow write: if isAdmin();
    }

    match /revisions/{document=**} {
      allow write: if isAdmin();
    }

    match /telemetryPotholes/{potholeId} {
      allow read: if isAdmin() || hasMunicipalAccess(resourceCityId());
      allow write: if true;
    }

    match /segmentNormalizedDaily/{cityId}/days/{date}/h3/{h3} {
      allow read: if isAdmin() || canReadMunicipalCity(cityId);
      allow write: if false;
    }

    match /potholeHotspotsDaily/{cityId}/days/{date}/points/{id} {
      allow read: if isAdmin() || canReadMunicipalCity(cityId);
      allow write: if false;
    }

    match /municipalDaily/{cityId}/days/{date} {
      allow read: if isAdmin() || canReadMunicipalCity(cityId);
      allow write: if false;
    }

    match /municipalDaily/{cityId} {
      allow read: if canReadMunicipalCity(cityId);
      allow write: if false;

      match /segments/{h3} {
        allow read: if canReadMunicipalCity(cityId);
        allow write: if false;
      }

      match /meta/{docId} {
        allow read: if canReadMunicipalCity(cityId);
        allow write: if false;
      }
    }

    match /contentPages/{slug} {
      allow read: if true;
    }

    match /faqs/{id} {
      allow read: if true;
    }

    match /supportInfo/{id} {
      allow read: if true;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
